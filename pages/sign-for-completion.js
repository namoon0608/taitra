import { useState, useRef } from "react";
import Head from "next/head";
import Nav from "../Components/Nav";
import Footer from "../Components/Footer";
import Hero from "../Components/Hero";
import styles from "../styles/Home.module.scss";
import { serverSideTranslations } from "next-i18next/serverSideTranslations";
import { useTranslation } from "next-i18next";
import SignaturePad from "react-signature-canvas";
import Popup from "../Components/Popup/Popup";

export async function getServerSideProps({ locale }) {
    const options = {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ lang: locale, show_id: "FD" }),
    };
    const infoRes = await fetch(
        `${process.env.API_BASE_URL}getDiscountInfo`,
        options
    );
    const infoData = await infoRes.json();

    return {
        props: {
            ...(await serverSideTranslations(locale, ["common"])),
            info: infoData,
        },
    };
}

export default function Sign(props) {
    const { t } = useTranslation();
    const [show, setShow] = useState(false);
    const [imageURL, setImageURL] = useState(null);

    const close = () => {
        setShow(false);
    };
    const sigCanvas = useRef({});
    const clear = () => sigCanvas.current.clear();
    const save = () => {
        setImageURL(
            sigCanvas.current.getTrimmedCanvas().toDataURL("image/png")
        );
        setShow(false);
    };

    return (
        <div className={styles.container}>
            <Head>
                <title>TAITRA</title>
                <meta
                    name="description"
                    content="Generated by create next app"
                />
                <link rel="icon" href="/img/logo.svg" />
            </Head>

            <Nav />
            <Hero info={props.info}>
                <h3>完工簽收</h3>
                <div className={styles.signItem}>
                    <table>
                        <thead>
                            <tr className={styles.title}>
                                <th>項次</th>
                                <th>申請項目</th>
                                <th>數量</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr className={styles.content}>
                                <td>1</td>
                                <td>用電110V電源箱 - 單相 110V 15A (1,500W)</td>
                                <td>1</td>
                            </tr>
                            <tr className={styles.content}>
                                <td>2</td>
                                <td>用電110V電源箱 - 單相 110V 15A (1,500W)</td>
                                <td>1</td>
                            </tr>
                            <tr className={styles.content}>
                                <td>3</td>
                                <td>用電110V電源箱 - 單相 110V 15A (1,500W)</td>
                                <td>1</td>
                            </tr>
                            <tr className={styles.content}>
                                <td>4</td>
                                <td>用電110V電源箱 - 單相 110V 15A (1,500W)</td>
                                <td>1</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div className={styles.sign}>
                    <button
                        className={styles.signBtn}
                        onClick={() => setShow(true)}
                    >
                        驗收簽名
                        <img src="/img/Vector.svg" width={25} height={21} />
                    </button>
                    <div className={styles.signImg}>
                        {imageURL ? <img src={imageURL} /> : null}
                    </div>
                </div>
                {show ? (
                    <Popup close={close}>
                        <div
                            className={styles.signature}
                            onClick={(e) => {
                                // do not close modal if anything inside modal content is clicked
                                e.stopPropagation();
                            }}
                        >
                            <SignaturePad
                                ref={sigCanvas}
                                canvasProps={{
                                    className: "signatureCanvas",
                                }}
                            ></SignaturePad>
                            <hr />
                            <p>請於上方簽名</p>
                            <div className={styles.signatureBtns}>
                                <button
                                    className={styles.buttons}
                                    onClick={clear}
                                >
                                    清除重簽
                                </button>
                                <button
                                    className={styles.buttons}
                                    onClick={save}
                                >
                                    確認
                                </button>
                            </div>
                        </div>
                    </Popup>
                ) : null}

                <button className={styles.signCheck}>確認</button>
            </Hero>
            <Footer />
        </div>
    );
}
